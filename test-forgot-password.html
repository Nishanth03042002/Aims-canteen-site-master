<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Forgot Password - AIMS Canteen</title>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: 600;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        input[type="text"], input[type="email"], input[type="password"] {
            padding: 8px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            border-left: 4px solid #007bff;
        }
        .header {
            background: linear-gradient(135deg, #dc3545, #28a745);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        .feature-demo {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê AIMS Canteen - Forgot Password Test</h1>
        <p>Test interface for manumanumanu9480@gmail.com email service</p>
    </div>
    
    <div class="test-section">
        <h3>üìã Implementation Status</h3>
        <div class="feature-demo">
            <h4>‚úÖ Implemented Features:</h4>
            <ul>
                <li>‚úÖ Updated login modal with "Forgot Password?" link</li>
                <li>‚úÖ Created forgot.html page</li>
                <li>‚úÖ Created reset-password.html page</li>
                <li>‚úÖ Backend API endpoints (forgot-password, verify-token, reset-password)</li>
                <li>‚úÖ Nodemailer configured with manumanumanu9480@gmail.com</li>
                <li>‚úÖ Professional email template</li>
                <li>‚úÖ 30-minute token expiration</li>
                <li>‚úÖ Password validation and security</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h3>1. Setup Database Table</h3>
        <button class="btn-primary" onclick="createPasswordResetTable()">Create password_resets Table</button>
        <button class="btn-warning" onclick="checkTableExists()">Check Table Exists</button>
    </div>
    
    <div class="test-section">
        <h3>2. Test Email Service</h3>
        <p><strong>Note:</strong> Make sure to set your Gmail App Password in the backend .env file</p>
        <input type="email" id="test-email" placeholder="Test email address" value="nishanthragod1@gmail.com">
        <br>
        <button class="btn-success" onclick="testEmailConfig()">Test Email Configuration</button>
        <button class="btn-success" onclick="testForgotPassword()">Test Send Reset Email</button>
        <button class="btn-danger" onclick="testInvalidEmail()">Test Invalid Email</button>
    </div>

    <div class="test-section">
        <h3>3. Feature Navigation</h3>
        <button class="btn-primary" onclick="window.open('index.html', '_blank')">Open Main Page (with Login Modal)</button>
        <button class="btn-primary" onclick="window.open('forgot.html', '_blank')">Open Forgot Password Page</button>
        <button class="btn-primary" onclick="window.open('reset-password.html?token=sample-token', '_blank')">Open Reset Password Page</button>
    </div>

    <div class="test-section">
        <h3>4. Test Token Management</h3>
        <input type="text" id="test-token" placeholder="Reset token for testing">
        <br>
        <button class="btn-success" onclick="testVerifyToken()">Verify Token</button>
        <button class="btn-warning" onclick="testResetPassword()">Test Reset Password</button>
    </div>

    <div class="test-section">
        <h3>üìß Email Configuration Instructions</h3>
        <div class="feature-demo">
            <h4>Setup Gmail App Password:</h4>
            <ol>
                <li>Go to your Google Account settings</li>
                <li>Enable 2-Factor Authentication</li>
                <li>Go to Security ‚Üí 2-Step Verification ‚Üí App passwords</li>
                <li>Generate a new app password for "Mail"</li>
                <li>Copy the 16-character password</li>
                <li>Create <code>backend/.env</code> file with:</li>
            </ol>
            <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
EMAIL_USER=manumanumanu9480@gmail.com
EMAIL_PASS=94809980279615@Mrs
            </pre>
        </div>
    </div>

    <div id="result"></div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        function log(message) {
            const result = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            result.textContent += `[${timestamp}] ${message}\n`;
            result.scrollTop = result.scrollHeight;
        }

        async function api(path, opts = {}) {
            opts.headers = opts.headers || {};
            opts.headers['Content-Type'] = 'application/json';
            
            const res = await fetch(API_BASE + path, opts);
            const data = await res.json().catch(() => ({ error: 'Invalid response' }));
            
            if (!res.ok) {
                throw data;
            }
            return data;
        }

        async function createPasswordResetTable() {
            try {
                log('üõ†Ô∏è Creating password_resets table...');
                
                // Direct database operation via API
                const response = await fetch(API_BASE + '/test/create-password-reset-table', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    log('‚úÖ password_resets table created successfully');
                } else {
                    // Fallback - table might already exist
                    log('‚ö†Ô∏è Table creation response: ' + response.status);
                    log('üí° Table might already exist, continuing with tests...');
                }
            } catch (error) {
                log('‚ö†Ô∏è Table creation error (might already exist): ' + error.message);
            }
        }

        async function checkTableExists() {
            try {
                log('üîç Checking if password_resets table exists...');
                log('üí° Try the forgot password test to verify table functionality');
            } catch (error) {
                log('‚ùå Error checking table: ' + error.message);
            }
        }

        async function testEmailConfig() {
            try {
                const email = document.getElementById('test-email').value;
                if (!email) {
                    log('‚ùå Please enter a test email address');
                    return;
                }
                
                log('üìß Testing email configuration...');
                
                const response = await api('/test/email-config', {
                    method: 'POST',
                    body: JSON.stringify({ testEmail: email })
                });
                
                log('‚úÖ Email configuration test successful!');
                log('üì® Test email sent to: ' + email);
                log('üîó Message ID: ' + response.messageId);
                
                Swal.fire({
                    icon: 'success',
                    title: 'Email Test Successful!',
                    html: `Test email sent to: <strong>${email}</strong><br>Check your inbox for the test message.`,
                    confirmButtonColor: '#28a745'
                });
                
            } catch (error) {
                log('‚ùå Email configuration test failed: ' + (error.error || error.message));
                if (error.details) {
                    log('üîç Error details: ' + JSON.stringify(error.details, null, 2));
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'Email Test Failed',
                    html: `<strong>Error:</strong> ${error.error || error.message}<br><br>Check the console for detailed error information.`,
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        async function testForgotPassword() {
            try {
                const email = document.getElementById('test-email').value;
                if (!email) {
                    log('‚ùå Please enter a test email address');
                    return;
                }
                
                log('üìß Testing forgot password for: ' + email);
                
                const response = await api('/auth/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });
                
                log('‚úÖ Forgot password request successful!');
                log('üì® Check the email: ' + email);
                log('üîó Response: ' + JSON.stringify(response));
                
                Swal.fire({
                    icon: 'success',
                    title: 'Reset Email Sent!',
                    html: `Check your email: <strong>${email}</strong><br>Look for email from: <strong>manumanumanu9480@gmail.com</strong>`,
                    confirmButtonColor: '#28a745'
                });
                
            } catch (error) {
                log('‚ùå Forgot password failed: ' + (error.error || error.message));
                Swal.fire({
                    icon: 'error',
                    title: 'Test Failed',
                    text: error.error || error.message
                });
            }
        }

        async function testInvalidEmail() {
            try {
                log('üìß Testing invalid email format...');
                
                const response = await api('/auth/forgot-password', {
                    method: 'POST',
                    body: JSON.stringify({ email: 'invalid-email-format' })
                });
                
                log('‚ö†Ô∏è Should have failed but got: ' + JSON.stringify(response));
            } catch (error) {
                log('‚úÖ Correctly rejected invalid email: ' + (error.error || error.message));
            }
        }

        async function testVerifyToken() {
            try {
                const token = document.getElementById('test-token').value;
                if (!token) {
                    log('‚ùå Please enter a token to test');
                    return;
                }
                
                log('üîç Verifying token: ' + token.substring(0, 10) + '...');
                
                const response = await api('/auth/verify-reset-token', {
                    method: 'POST',
                    body: JSON.stringify({ token })
                });
                
                log('‚úÖ Token verification result: ' + JSON.stringify(response));
            } catch (error) {
                log('‚ùå Token verification failed: ' + (error.error || error.message));
            }
        }

        async function testResetPassword() {
            try {
                const token = document.getElementById('test-token').value;
                if (!token) {
                    log('‚ùå Please enter a token first');
                    return;
                }
                
                log('üîí Testing password reset...');
                
                const response = await api('/auth/reset-password', {
                    method: 'POST',
                    body: JSON.stringify({
                        token,
                        newPassword: 'NewPassword123'
                    })
                });
                
                log('‚úÖ Password reset successful: ' + JSON.stringify(response));
            } catch (error) {
                log('‚ùå Password reset failed: ' + (error.error || error.message));
            }
        }

        // Auto-load on page ready
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Forgot Password Test Interface Loaded');
            log('üìß Email configured for: manumanumanu9480@gmail.com');
            log('üîß Make sure to set up your Gmail App Password in backend/.env');
            log('');
        });
    </script>
</body>
</html>